
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Changing Server Stacks is Not Fun - Photographer.io Blog</title>
  <meta name="author" content="Robert May">

  
  <meta name="description" content="Every evening for the past week has been spent preparing to move Photographer.io to a new server architecture. We were previously on Heroku, and we& &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.photographer.io/posts/2013/06/19/changing-server-stacks-is-not-fun">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Photographer.io Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="https://www.photographer.io/">Photographer.io Blog</a></h1>
  
    <h2>The photo community for enthusiasts</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.photographer.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Changing Server Stacks is Not Fun</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-06-19T23:46:00+01:00" pubdate data-updated="true">Jun 19<span>th</span>, 2013</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Every evening for the past week has been spent preparing to move <a href="https://www.photographer.io">Photographer.io</a> to a new server architecture. We were previously on <a href="https://www.heroku.com">Heroku</a>, and we&rsquo;re now running on a custom server setup on <a href="https://www.digitalocean.com/?refcode=0d41e836e212">Digital Ocean</a>.</p>

<p>The past few days have made me both excited and incredibly frustrated with running a web application. Here&rsquo;s a few details on why.</p>

<!-- more -->


<h3>Heroku</h3>

<p>I like Heroku. We use Heroku a lot <a href="http://wearebarenaked.com">at my day job</a> and it&rsquo;s a really good way of launching an app. It is, however,  <em>incredibly expensive</em>. Now I&rsquo;m talking primarily about web/worker processes here, as I think <a href="https://postgres.heroku.com">Heroku Postgres</a> is actually reasonable value and it&rsquo;s a fantastic service. I understand that there&rsquo;s a lot more to the stack on Heroku than just running your web process, but it&rsquo;s $35 a month for poorer performance than what you can achieve for $5 on Digital Ocean, or $15 on most other VPS providers.</p>

<h3>Digital Ocean</h3>

<p>It&rsquo;s very cheap. This is a real boon for me as it lets me run the server stack I want; load balancers, web servers, redundant database servers, and a general utility/cache server; all for less than half what it costs on Heroku. And the performance benefits that come along with it are just the icing on the cake.</p>

<p>Digital Ocean are currently experiencing massive growth and I&rsquo;m sure that&rsquo;s going to result in a bit of instability over the next few weeks/months whilst they scale. I&rsquo;m not too fussed right now though, as Photographer.io still hasn&rsquo;t formally launched or been promoted in any significant way. It&rsquo;s a good time to try out a new architecture and get used to its quirks before (hopefully) gaining a lot of traffic.</p>

<h3>The Pain</h3>

<p>I must admit that I&rsquo;m not the happiest of sysadmins. There are some pieces of software which are a joy to set up (<a href="http://haproxy.1wt.eu/">HAProxy</a>, <a href="http://memcached.org/">Memcached</a>, <a href="http://redis.io">Redis</a>), and then there are those which make me swear and perform any number of hexes on the developers who designed them (<a href="http://www.postgresql.org/">PostgreSQL</a>). Having to set up my own Postgres server made me seriously regret ever having chosen it; MariaDB would have been a much simpler choice.</p>

<p>I have not suffered in vain, however, as the site is now significantly quicker to respond than it was whilst on Heroku and I&rsquo;m much happier with the costs involved.</p>

<h3>The New Setup</h3>

<p>This is what&rsquo;s currently running for the initial launch of this stack:</p>

<ul>
<li>2x 512MB HAProxy Load Balancers (nothing clever for failover at the moment, just a DNS toggle)</li>
<li>2x 2GB Web/Worker Servers, running Ruby 2.0, Puma, Sidekiq</li>
<li>2x 1GB Database Servers, Postgres 9.2</li>
<li>1x 512MB Utility Server, Memcached/Redis</li>
</ul>


<p>It&rsquo;s not perfect but it leaves plenty of room for scaling. I&rsquo;d like to move over to JRuby to make better use of the resources available but there are a few bugs I need to iron out before I can switch.</p>

<h4>Other Bits</h4>

<p><a href="https://www.cloudflare.com">CloudFlare</a> sits in front of the load balancers to help provide a variety of extra services (notably better security). Backups of data are handled using <a href="https://www.tarsnap.com">Tarsnap</a> for excellent data security and as I&rsquo;ve got nothing but great things to say about it.</p>

<h3>Token Poorly Labelled Charts</h3>

<p>Here&rsquo;s a totally unreliable but somewhat interesting comparison of the past hour, from two days ago whilst running on Heroku:</p>

<p><img src="/images/posts/7/heroku_stack.png" alt="Heroku Performance" /></p>

<p>And the same data for the past hour today on Digital Ocean (when I remembered to re-enable NewRelic):</p>

<p><img src="/images/posts/7/do_stack.png" alt="Digital Ocean Performance" /></p>

<p>Finally the performance data is starting to look how you&rsquo;d expect from an application written in a modern scripting language: the application is by far the slowest component.</p>

<h3>Processing Photos Was Expensive</h3>

<p>On Heroku processing the often very large photos people uploaded was quite expensive. If someone batch uploads 100 photographs, a worker will be churning away for quite a while on a number of jobs at once. To manage this at all on Heroku required a 1GB worker dyno at $72 per month. On Digital Ocean I&rsquo;m running the workers on the same servers as the web processes (2GB RAM shared between the processes) and it&rsquo;s $20 per month. You could run a server with 8GB of RAM for $8 more than 1GB costs you on Heroku.</p>

<h3>Time Will Tell</h3>

<p>Now that the switch is complete, I&rsquo;ll be spending the next few weeks keeping a close eye on log files and server stats (<a href="https://boundary.com">Boundary</a> is pretty cool, though I just look at the pretty graphs) and adjusting things as I go along. One of the best things I&rsquo;ve taken away from this is that Digital Ocean is letting me play at running a server architecture more akin to those run by high traffic apps without having to stump up the cash to do so. It&rsquo;s certainly more complicated than running on Heroku, and I&rsquo;m really hoping that technologies like <a href="http://docker.io">Docker</a> gain a lot of traction in the near future. Setting up this server stack over the past week brought me very close to chucking it all in and going to live in the woods and carve wooden spoons*.</p>

<p><sup><a href="https://www.photographer.io/photographs/2782">I do that anyway</a>, but it&rsquo;s not a hugely profitable career</sup></p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Robert May</span></span>

      








  


<time datetime="2013-06-19T23:46:00+01:00" pubdate data-updated="true">Jun 19<span>th</span>, 2013</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/platform/'>Platform</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://blog.photographer.io/posts/2013/06/19/changing-server-stacks-is-not-fun/" data-via="photographer_io" data-counturl="http://blog.photographer.io/posts/2013/06/19/changing-server-stacks-is-not-fun/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/posts/2013/06/08/username-support/" title="Previous Post: Username Support">&laquo; Username Support</a>
      
      
        <a class="basic-alignment right" href="/posts/2013/07/07/terms-of-service/" title="Next Post: Terms of Service">Terms of Service &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>About Photographer.io</h1>
  <p>
  <a href="https://photographer.io">Photographer.io</a> is a new photo sharing community aiming to provide the best and
  most customisable experience for photographers looking to share their photographs.
  <br/>
  It's currently in open beta and all feedback is more than welcome. Send any enquiries to <a href="mailto:support@photographer.io">support@photographer.io</a>.
  </p>
</section>

<section>
  <h1>Robert May</h1>
  <p>
    You're also more than welcome to contact me via Twitter (<a href="http://twitter.com/robotmay">@robotmay</a>) or via email at <a href="mailto:rob@photographer.io">rob@photographer.io</a>.
  </p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/posts/2013/07/09/translating-photographer-dot-io/">Translating Photographer.io</a>
      </li>
    
      <li class="post">
        <a href="/posts/2013/07/08/were-now-open-source/">We're now Open Source!</a>
      </li>
    
      <li class="post">
        <a href="/posts/2013/07/07/terms-of-service/">Terms of Service</a>
      </li>
    
      <li class="post">
        <a href="/posts/2013/06/19/changing-server-stacks-is-not-fun/">Changing Server Stacks is Not Fun</a>
      </li>
    
      <li class="post">
        <a href="/posts/2013/06/08/username-support/">Username Support</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Twitter</h1>
  <a class="twitter-timeline" data-dnt="true" href="https://twitter.com/photographer_io"  data-widget-id="347509273703628800">Tweets by @photographer_io</a>
  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
Copyright &copy; 2013 Robert May, Afternoon Robot Ltd -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

<script type="text/javascript">
  var _gauges = _gauges || [];
  (function() {
    var t   = document.createElement('script');
    t.type  = 'text/javascript';
    t.async = true;
    t.id    = 'gauges-tracker';
    t.setAttribute('data-site-id', '51a4b9e6613f5d6aef000001');
    t.src = '//secure.gaug.es/track.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(t, s);
  })();
</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-41499549-1', 'photographer.io');
  ga('send', 'pageview');

</script>

</footer>
  





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
